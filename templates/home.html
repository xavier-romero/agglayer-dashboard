{% extends "base.html" %}

{% block title %}AggLayer Dashboard - Kurtosis{% endblock %}

{% block content %}
<h2>Kurtosis Environment</h2>

<div class="card">
    {% if summary.isConnected %}
    <p class="status-connected">‚úÖ Connected</p>
    {% else %}
    <p class="status-error">‚ùå L1 RPC Connection Error</p>
    {% endif %}
    
    {% if summary.error %}
    <p class="status-error">Error: {{ summary.error }}</p>
    {% else %}
    <table class="detail-table">
        <tr>
            <th>L1 RPC URL</th>
            <td><code>{{ summary.rpcURL }}</code></td>
        </tr>
        {% if summary.aggLayerURL %}
        <tr class="agglayer-row">
            <th>AggLayer URL</th>
            <td>
                <div class="rollup-header" onclick="toggleAggLayerUrlDetails()" style="padding: 8px 0; background: transparent; border: none; justify-content: flex-start; gap: 10px;">
                    <code>{{ summary.aggLayerURL }}</code>
                    <span class="expand-arrow" id="expandArrowAggLayerUrl">‚ñº</span>
                </div>
            </td>
        </tr>
        {% if summary.epochConfig %}
        <tr class="agglayer-url-details" id="aggLayerUrlDetails" style="display: none;">
            <td colspan="2">
                <div class="details-container">
                    <h4 style="margin: 0 0 15px 0; color: #007bff;">‚è∞ AggLayer Epoch Configuration</h4>
                    
                    <div class="details-section">
                        <div class="details-grid">
                            <div class="detail-item">
                                <span class="detail-label">Genesis Block:</span>
                                <span class="detail-value">{{ summary.epochConfig.genesis_block }}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Epoch Duration:</span>
                                <span class="detail-value">{{ summary.epochConfig.epoch_duration }} seconds</span>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </td>
        </tr>
        {% endif %}
        {% endif %}
        {% if summary.networkAddresses %}
        <tr style="border-top: 2px solid #eee;">
            <th colspan="2" style="text-align: center; padding: 10px; background-color: #f8f9fa; font-weight: bold;">Network Contract Addresses</th>
        </tr>
        <tr class="rollup-manager-row">
            <th>Rollup Manager</th>
            <td>
                <div class="rollup-header" onclick="toggleRollupManagerDetails()" style="padding: 8px 0; background: transparent; border: none; justify-content: flex-start; gap: 10px;">
                    <code>{{ summary.rollupManagerAddress }}</code>
                    <span class="expand-arrow" id="expandArrowRollupManager">‚ñº</span>
                </div>
            </td>
        </tr>
        {% if summary.rollupManagerDetails %}
        <tr class="rollup-manager-details" id="rollupManagerDetails" style="display: none;">
            <td colspan="2">
                <div class="details-container">
                    <h4 style="margin: 0 0 15px 0; color: #007bff;">üìä Rollup Manager Details</h4>
                    
                    <!-- System Status -->
                    <div class="details-section">
                        <h5>üö¶ System Status</h5>
                        <div class="details-grid">
                            <div class="detail-item">
                                <span class="detail-label">Emergency State:</span>
                                <span class="detail-value">
                                    {% if summary.rollupManagerDetails.isEmergencyState %}
                                        <span class="status-error">üö® EMERGENCY</span>
                                    {% else %}
                                        <span class="status-connected">‚úÖ Normal</span>
                                    {% endif %}
                                </span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Manager Version:</span>
                                <span class="detail-value">{{ summary.rollupManagerDetails.rollupManagerVersion or "Unknown" }}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Rollup Type Count:</span>
                                <span class="detail-value">{{ summary.rollupManagerDetails.rollupTypeCount or 0 }}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">POL Token:</span>
                                <span class="detail-value"><code class="full-address">{{ summary.networkAddresses.polAddress }}</code></span>
                            </div>
                        </div>
                    </div>

                    <!-- Timing Information -->
                    <div class="details-section">
                        <h5>‚è±Ô∏è Timing & History</h5>
                        <div class="details-grid">
                            <div class="detail-item">
                                <span class="detail-label">Last Aggregation:</span>
                                <span class="detail-value">
                                    {{ summary.rollupManagerDetails.lastAggregationRelative }}
                                    {% if summary.rollupManagerDetails.lastAggregationTime != "Never" %}
                                        <br><small style="color: #666;">{{ summary.rollupManagerDetails.lastAggregationTime }}</small>
                                    {% endif %}
                                </span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Last Emergency Recovery:</span>
                                <span class="detail-value">
                                    {{ summary.rollupManagerDetails.lastEmergencyRecoveryRelative }}
                                    {% if summary.rollupManagerDetails.lastEmergencyRecoveryTime != "Never" %}
                                        <br><small style="color: #666;">{{ summary.rollupManagerDetails.lastEmergencyRecoveryTime }}</small>
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Cast Commands Legend -->
                    <div class="cast-commands-section">
                        <div class="cast-commands-header" onclick="toggleCastCommands('rollupManager')">
                            üìã Cast Commands <span class="expand-arrow" id="castArrow-rollupManager">‚ñº</span>
                        </div>
                        <div class="cast-commands-content" id="castCommands-rollupManager" style="display: none;">
                            <pre><code># Rollup Manager Details
# Set environment variables
export RPC_URL="{{ summary.rpcURL }}"
export ROLLUP_MANAGER="{{ summary.rollupManagerAddress }}"

# Emergency State
cast call --rpc-url $RPC_URL $ROLLUP_MANAGER "isEmergencyState()"

# Manager Version
cast call --rpc-url $RPC_URL $ROLLUP_MANAGER "ROLLUP_MANAGER_VERSION()(string)"

# Rollup Type Count
cast call --rpc-url $RPC_URL $ROLLUP_MANAGER "rollupTypeCount()"

# POL Token Address
cast call --rpc-url $RPC_URL $ROLLUP_MANAGER "pol()"</code></pre>
                        </div>
                    </div>

                    <!-- Individual Rollups -->
                    {% if summary.rollupManagerDetails.rollups and summary.rollupManagerDetails.rollups|length > 0 %}
                    <div class="details-section">
                        <h5>üîó Rollups ({{ rollups|length }})</h5>
                        <div class="rollup-list">
                            {% for rollup in rollups %}
                            <div class="rollup-item">
                                <div class="rollup-header" onclick="toggleRollupDetails('{{ rollup.rollupID }}')" style="cursor: pointer;">
                                    <div class="rollup-title">
                                        <strong>Rollup #{{ rollup.rollupID }}</strong>
                                        <span style="margin-left: 10px; padding: 2px 6px; background: #e3f2fd; color: #1976d2; border-radius: 12px; font-size: 0.8em;">
                                            {{ rollup.rollupVerifierTypeFriendly }}{% if rollup.rollupVerifierType == 2 and rollup.aggchainType %} ({{ rollup.aggchainType }}){% endif %}
                                        </span>
                                        {% if rollup.isActive %}
                                            <span style="margin-left: 5px; color: #4caf50;">‚úÖ</span>
                                        {% else %}
                                            <span style="margin-left: 5px; color: #f44336;">‚ùå</span>
                                        {% endif %}
                                    </div>
                                    <span class="expand-arrow" id="arrow-{{ rollup.rollupID }}">‚ñº</span>
                                </div>
                                <div class="rollup-details" id="rollupDetails-{{ rollup.rollupID }}" style="display: none;">
                                    <div class="rollup-details-grid">
                                        <div class="detail-item">
                                            <span class="detail-label">Contract:</span>
                                            <span class="detail-value">
                                                {% if rollup.rollupContract != "0x0000000000000000000000000000000000000000" %}
                                                    <code class="full-address">{{ rollup.rollupContract }}</code>
                                                {% else %}
                                                    <span style="color: #666;">Not deployed</span>
                                                {% endif %}
                                            </span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">L2 RPC URL:</span>
                                            <span class="detail-value">
                                                {% if summary.l2rpcs and summary.l2rpcs.get(rollup.rollupID|string) %}
                                                    <code class="full-address">{{ summary.l2rpcs.get(rollup.rollupID|string) }}</code>
                                                {% else %}
                                                    <span style="color: #666;">Not configured</span>
                                                {% endif %}
                                            </span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Rollup Type ID:</span>
                                            <span class="detail-value">{{ rollup.rollupTypeID }}</span>
                                        </div>
                                        {% if rollup.rollupVerifierType == 2 %}
                                        <div class="detail-item">
                                            <span class="detail-label">Aggchain Type:</span>
                                            <span class="detail-value">{{ rollup.aggchainType | default("N/A") }}</span>
                                        </div>
                                        {% if rollup.aggchainType == "FEP" and rollup.optimisticMode is not none %}
                                        <div class="detail-item">
                                            <span class="detail-label">Optimistic Mode:</span>
                                            <span class="detail-value">
                                                {% if rollup.optimisticMode %}True{% else %}False{% endif %}
                                                {% if rollup.hasAgchainManagerKey %}
                                                <button 
                                                    id="toggleOptimistic-{{ rollup.rollupID }}"
                                                    onclick="toggleOptimisticMode({{ rollup.rollupID }}, {{ rollup.optimisticMode | lower }})"
                                                    style="margin-left: 10px; padding: 4px 8px; font-size: 0.8em; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; background: {% if rollup.optimisticMode %}#f44336{% else %}#4caf50{% endif %}; color: white;">
                                                    {% if rollup.optimisticMode %}Disable(){% else %}Enable(){% endif %}
                                                </button>
                                                {% endif %}
                                            </span>
                                        </div>
                                        {% endif %}
                                        {% endif %}
                                        <div class="detail-item">
                                            <span class="detail-label">Consensus Implementation:</span>
                                            <span class="detail-value"><code class="full-address">{{ rollup.rollupTypeConsensus or rollup.consensusImplementation }}</code></span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Network Name:</span>
                                            <span class="detail-value">
                                                {% if rollup.networkName %}
                                                    {{ rollup.networkName }}
                                                {% else %}
                                                    <span style="color: #666;">Not available</span>
                                                {% endif %}
                                            </span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Sequencer URL:</span>
                                            <span class="detail-value">
                                                {% if rollup.trustedSequencerURL %}
                                                    <code class="full-address">{{ rollup.trustedSequencerURL }}</code>
                                                {% else %}
                                                    <span style="color: #666;">Not available</span>
                                                {% endif %}
                                            </span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Verifier:</span>
                                            <span class="detail-value">
                                                <code class="full-address">{{ rollup.verifier }}</code>
                                                {% if rollup.verifier == "0x0000000000000000000000000000000000000000" %}
                                                    {% if rollup.rollupVerifierType == 1 %}
                                                        <br><small style="color: #666;">‚úÖ Expected: Pessimistic Proof rollups use zero address</small>
                                                    {% elif rollup.rollupVerifierType == 2 %}
                                                        <br><small style="color: #666;">‚úÖ Expected: AggLayer Gateway rollups use zero address</small>
                                                    {% endif %}
                                                {% endif %}
                                            </span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Verifier Type:</span>
                                            <span class="detail-value">
                                                {{ rollup.rollupVerifierTypeFriendly or rollup.rollupVerifierType }}
                                                <span style="color: #666; font-size: 0.9em;">({{ rollup.rollupVerifierType }})</span>
                                            </span>
                                        </div>
                                        {% if rollup.programVKey %}
                                        <div class="detail-item">
                                            <span class="detail-label">Program VKey:</span>
                                            <span class="detail-value"><code class="full-address">{{ rollup.programVKey }}</code></span>
                                        </div>
                                        {% endif %}
                                        {% if rollup.trustedSequencer %}
                                        <div class="detail-item">
                                            <span class="detail-label">Trusted Sequencer Address:</span>
                                            <span class="detail-value"><code class="full-address">{{ rollup.trustedSequencer }}</code></span>
                                        </div>
                                        {% endif %}
                                        <div class="detail-item">
                                            <span class="detail-label">Chain ID:</span>
                                            <span class="detail-value">{{ rollup.chainID }}</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Fork ID:</span>
                                            <span class="detail-value">{{ rollup.forkID }}</span>
                                        </div>
                                        {% if rollup.rollupTypeProgramVKey %}
                                        <div class="detail-item program-vkey-item">
                                            <span class="detail-label">Program VKey:</span>
                                            <span class="detail-value program-vkey">{{ rollup.rollupTypeProgramVKey }}</span>
                                        </div>
                                        {% endif %}
                                        {% if rollup.lastLocalExitRoot %}
                                        <div class="detail-item">
                                            <span class="detail-label">Last Local Exit Root:</span>
                                            <span class="detail-value"><code>{{ rollup.lastLocalExitRoot }}</code></span>
                                        </div>
                                        {% endif %}
                                        
                                        <!-- Multisig Information Section -->
                                        {% if rollup.rollupVerifierType == 2 %}
                                        <div class="detail-item" style="grid-column: 1 / -1;">
                                            <div style="display: flex; align-items: center; gap: 10px; margin: 10px 0 5px 0;">
                                                <h6 style="margin: 0; color: #555; font-size: 0.9em;">üë• Multisig Information</h6>
                                                <button 
                                                    onclick="toggleMultisigInfo('{{ rollup.rollupID }}')" 
                                                    style="padding: 2px 6px; font-size: 0.7em; border: 1px solid #ddd; border-radius: 3px; cursor: pointer; background: #f8f9fa;">
                                                    <span id="multisigArrow-{{ rollup.rollupID }}">‚ñº</span>
                                                </button>
                                                <button 
                                                    onclick="refreshMultisigInfo({{ rollup.rollupID }})" 
                                                    style="padding: 2px 6px; font-size: 0.7em; border: 1px solid #2196f3; border-radius: 3px; cursor: pointer; background: #e3f2fd; color: #1976d2;">
                                                    üîÑ
                                                </button>
                                            </div>
                                            <div id="multisig-{{ rollup.rollupID }}" class="multisig-content" style="display: none; margin-top: 8px;">
                                                <div style="font-size: 0.85em; color: #666; margin-bottom: 5px;">Loading multisig data...</div>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Certificate Information Section -->
                                    <div class="detail-item" style="grid-column: 1 / -1; margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px;">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <h6 style="margin: 0; color: #555; font-size: 0.9em;">üìú AggLayer Certificates</h6>
                                            <button 
                                                onclick="toggleCertificates('{{ rollup.rollupID }}')" 
                                                style="padding: 2px 6px; font-size: 0.7em; border: 1px solid #ddd; border-radius: 3px; cursor: pointer; background: #f8f9fa;">
                                                <span id="certArrow-{{ rollup.rollupID }}">‚ñº</span>
                                            </button>
                                            <button 
                                                onclick="refreshCertificates({{ rollup.rollupID }})" 
                                                style="padding: 2px 6px; font-size: 0.7em; border: 1px solid #2196f3; border-radius: 3px; cursor: pointer; background: #e3f2fd; color: #1976d2;">
                                                üîÑ
                                            </button>
                                        </div>
                                        <div id="certificates-{{ rollup.rollupID }}" class="certificates-content" style="display: none; margin-top: 10px;">
                                            <div style="font-size: 0.85em; color: #666; margin-bottom: 5px;">Loading certificate data...</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Cast Commands Legend -->
                                    <div class="cast-commands-section">
                                        <div class="cast-commands-header" onclick="toggleCastCommands('rollup{{ rollup.rollupID }}')">
                                            üìã Cast Commands <span class="expand-arrow" id="castArrow-rollup{{ rollup.rollupID }}">‚ñº</span>
                                        </div>
                                        <div class="cast-commands-content" id="castCommands-rollup{{ rollup.rollupID }}" style="display: none;">
                                            <pre><code># Individual Rollup Details (Rollup #{{ rollup.rollupID }})
# Set environment variables
export RPC_URL="{{ summary.rpcURL }}"
export ROLLUP_MANAGER="{{ summary.rollupManagerAddress }}"
export ROLLUP_CONTRACT="{{ rollup.rollupContract }}"
export ROLLUP_ID={{ rollup.rollupID }}

# Network Name
cast call --rpc-url $RPC_URL $ROLLUP_CONTRACT "networkName()(string)"

# Trusted Sequencer URL  
cast call --rpc-url $RPC_URL $ROLLUP_CONTRACT "trustedSequencerURL()(string)"

# Trusted Sequencer Address
cast call --rpc-url $RPC_URL $ROLLUP_CONTRACT "trustedSequencer()(address)"

# Get Full Rollup Data
cast call --rpc-url $RPC_URL $ROLLUP_MANAGER "rollupIDToRollupDataDeserialized(uint32)(address,uint64,address,uint64,bytes32,uint64,uint64,uint64,uint64,uint64,uint64,uint8)" $ROLLUP_ID

# Chain ID is at index 0 of returned tuple
# Verifier Address is at index 2 of returned tuple  
# Fork ID is at index 3 of returned tuple
# Verifier Type is at index 11 of returned tuple

# Get Rollup Type Details (for Program VKey)
export ROLLUP_TYPE_ID=$(cast call --rpc-url $RPC_URL $ROLLUP_MANAGER "rollupIDToRollupDataDeserialized(uint32)" $ROLLUP_ID | cut -d' ' -f11)
cast call --rpc-url $RPC_URL $ROLLUP_MANAGER "rollupTypeMap(uint32)(address,uint64,address,address,bytes32,string)" $ROLLUP_TYPE_ID

# Rollup-Level Signers Information (from individual rollup contract)
cast call --rpc-url $RPC_URL $ROLLUP_CONTRACT "getAggchainSignersCount()(uint256)"
cast call --rpc-url $RPC_URL $ROLLUP_CONTRACT "getThreshold()(uint256)"
cast call --rpc-url $RPC_URL $ROLLUP_CONTRACT "getAggchainSignerInfos()(tuple(address,string)[])"
cast call --rpc-url $RPC_URL $ROLLUP_CONTRACT "getAggchainMultisigHash()(bytes32)"
cast call --rpc-url $RPC_URL $ROLLUP_CONTRACT "useDefaultSigners()(bool)"

# Aggchain Type (for AggLayer Gateway rollups only)
cast call --rpc-url $RPC_URL $ROLLUP_CONTRACT "AGGCHAIN_TYPE()(bytes2)"

# Optimistic Mode (for FEP AggLayer Gateway rollups only)
cast call --rpc-url $RPC_URL $ROLLUP_CONTRACT "optimisticMode()(bool)"

# Enable Optimistic Mode
cast send --rpc-url $RPC_URL --private-key $PRIVATE_KEY $ROLLUP_CONTRACT "enableOptimisticMode()"

# Disable Optimistic Mode  
cast send --rpc-url $RPC_URL --private-key $PRIVATE_KEY $ROLLUP_CONTRACT "disableOptimisticMode()"

# Update Threshold (when not using AgglGW signers)
cast send --rpc-url $RPC_URL --private-key $PRIVATE_KEY $ROLLUP_CONTRACT "updateSignersAndThreshold(tuple(address,uint256)[],tuple(address,string)[],uint256)" "[]" "[]" NEW_THRESHOLD_VALUE</code></pre>
                                        </div>
                                    </div>
                                    
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </td>
        </tr>
        {% endif %}
        <tr class="bridge-row">
            <th>Bridge Contract</th>
            <td>
                <div class="rollup-header" onclick="toggleBridgeDetails()" style="padding: 8px 0; background: transparent; border: none; justify-content: flex-start; gap: 10px;">
                    <code>{{ summary.networkAddresses.bridgeAddress }}</code>
                    <span class="expand-arrow" id="expandArrowBridge">‚ñº</span>
                </div>
            </td>
        </tr>
        {% if summary.bridgeDetails and summary.bridgeDetails.keys()|length > 0 %}
        <tr class="bridge-details" id="bridgeDetails" style="display: none;">
            <td colspan="2">
                <div class="details-container">
                    <h4 style="margin: 0 0 15px 0; color: #007bff;">üåâ Bridge Details</h4>
                    
                    <!-- System Status -->
                    <div class="details-section">
                        <h5>üö¶ Status & Versions</h5>
                        <div class="details-grid">
                            <div class="detail-item">
                                <span class="detail-label">Emergency State:</span>
                                <span class="detail-value">
                                    {% if summary.bridgeDetails.isEmergencyState %}
                                        <span class="status-error">üö® EMERGENCY</span>
                                    {% else %}
                                        <span class="status-connected">‚úÖ Normal</span>
                                    {% endif %}
                                </span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Bridge Version:</span>
                                <span class="detail-value">{{ summary.bridgeDetails.bridgeVersion or "Unknown" }}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Network ID:</span>
                                <span class="detail-value">{{ summary.bridgeDetails.networkID if summary.bridgeDetails.networkID is not none else "Unknown" }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Deposits & Activity -->
                    <div class="details-section">
                        <h5>üí∞ Deposits & Activity</h5>
                        <div class="details-grid">
                            <div class="detail-item">
                                <span class="detail-label">Total Deposits:</span>
                                <span class="detail-value">{{ "{:,}".format(summary.bridgeDetails.depositCount or 0) }}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Last Updated Count:</span>
                                <span class="detail-value">{{ "{:,}".format(summary.bridgeDetails.lastUpdatedDepositCount or 0) }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Configuration -->
                    <div class="details-section">
                        <h5>‚öôÔ∏è Configuration</h5>
                        <div class="details-grid">
                            {% if summary.bridgeDetails.bridgeManager %}
                            <div class="detail-item">
                                <span class="detail-label">Bridge Manager:</span>
                                <span class="detail-value"><code class="full-address">{{ summary.bridgeDetails.bridgeManager }}</code></span>
                            </div>
                            {% endif %}
                            <div class="detail-item">
                                <span class="detail-label">Gas Token:</span>
                                <span class="detail-value">
                                    {% if summary.bridgeDetails.gasTokenAddress and summary.bridgeDetails.gasTokenAddress != "0x0000000000000000000000000000000000000000" %}
                                        <code class="full-address">{{ summary.bridgeDetails.gasTokenAddress }}</code>
                                    {% else %}
                                        <span style="color: #666;">ETH (Native)</span>
                                    {% endif %}
                                </span>
                            </div>
                            {% if summary.bridgeDetails.gasTokenNetwork is not none %}
                            <div class="detail-item">
                                <span class="detail-label">Gas Token Network:</span>
                                <span class="detail-value">{{ summary.bridgeDetails.gasTokenNetwork }}</span>
                            </div>
                            {% endif %}
                            {% if summary.bridgeDetails.wethToken %}
                            <div class="detail-item">
                                <span class="detail-label">WETH Token:</span>
                                <span class="detail-value"><code class="full-address">{{ summary.bridgeDetails.wethToken }}</code></span>
                            </div>
                            {% endif %}
                            {% if summary.bridgeDetails.globalExitRootManager %}
                            <div class="detail-item">
                                <span class="detail-label">Global Exit Root Manager:</span>
                                <span class="detail-value"><code class="full-address">{{ summary.bridgeDetails.globalExitRootManager }}</code></span>
                            </div>
                            {% endif %}
                            {% if summary.bridgeDetails.polygonRollupManager %}
                            <div class="detail-item">
                                <span class="detail-label">Polygon Rollup Manager:</span>
                                <span class="detail-value"><code class="full-address">{{ summary.bridgeDetails.polygonRollupManager }}</code></span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Roots & Hashes -->
                    {% if summary.bridgeDetails.currentRoot %}
                    <div class="details-section">
                        <h5>üå≥ Roots & State</h5>
                        <div class="details-grid">
                            <div class="detail-item">
                                <span class="detail-label">Current Root:</span>
                                <span class="detail-value"><code class="program-vkey">{{ summary.bridgeDetails.currentRoot }}</code></span>
                            </div>
                            {% if summary.bridgeDetails.claimedGlobalIndexHashChain %}
                            <div class="detail-item">
                                <span class="detail-label">Claimed Global Index Hash:</span>
                                <span class="detail-value"><code class="program-vkey">{{ summary.bridgeDetails.claimedGlobalIndexHashChain }}</code></span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Cast Commands Legend -->
                    <div class="cast-commands-section">
                        <div class="cast-commands-header" onclick="toggleCastCommands('bridge')">
                            üìã Cast Commands <span class="expand-arrow" id="castArrow-bridge">‚ñº</span>
                        </div>
                        <div class="cast-commands-content" id="castCommands-bridge" style="display: none;">
                            <pre><code># Bridge Contract Details
# Set environment variables
export RPC_URL="{{ summary.rpcURL }}"
export ROLLUP_MANAGER="{{ summary.rollupManagerAddress }}"

# Get Bridge Address
BRIDGE_ADDRESS=$(cast call --rpc-url $RPC_URL $ROLLUP_MANAGER "bridgeAddress()(address)")
export BRIDGE_ADDRESS

# Bridge Version
cast call --rpc-url $RPC_URL $BRIDGE_ADDRESS "BRIDGE_VERSION()(string)"

# Emergency State
cast call --rpc-url $RPC_URL $BRIDGE_ADDRESS "isEmergencyState()(bool)"

# Network ID
cast call --rpc-url $RPC_URL $BRIDGE_ADDRESS "networkID()(uint32)"

# Deposit Count
cast call --rpc-url $RPC_URL $BRIDGE_ADDRESS "depositCount()(uint256)"

# Gas Token Address
cast call --rpc-url $RPC_URL $BRIDGE_ADDRESS "gasTokenAddress()(address)"

# Gas Token Network
cast call --rpc-url $RPC_URL $BRIDGE_ADDRESS "gasTokenNetwork()(uint32)"

# Global Exit Root Manager
cast call --rpc-url $RPC_URL $BRIDGE_ADDRESS "globalExitRootManager()(address)"

# Polygon Rollup Manager
cast call --rpc-url $RPC_URL $BRIDGE_ADDRESS "polygonRollupManager()(address)"</code></pre>
                        </div>
                    </div>
                </div>
            </td>
        </tr>
        {% endif %}
        <tr class="ger-row">
            <th>Global Exit Root Manager</th>
            <td>
                <div class="rollup-header" onclick="toggleGerDetails()" style="padding: 8px 0; background: transparent; border: none; justify-content: flex-start; gap: 10px;">
                    <code>{{ summary.networkAddresses.globalExitRootManager }}</code>
                    <span class="expand-arrow" id="expandArrowGer">‚ñº</span>
                </div>
            </td>
        </tr>
        {% if summary.gerDetails %}
        <tr class="ger-details" id="gerDetails" style="display: none;">
            <td colspan="2">
                <div class="details-container">
                    <h4 style="margin: 0 0 15px 0; color: #007bff;">üå≥ Global Exit Root Manager Details</h4>
                    
                    <!-- System Status -->
                    <div class="details-section">
                        <h5>üö¶ Status & Version</h5>
                        <div class="details-grid">
                            <div class="detail-item">
                                <span class="detail-label">GER Version:</span>
                                <span class="detail-value">{{ summary.gerDetails.gerVersion if summary.gerDetails.gerVersion is not none else "Unknown" }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Configuration -->
                    <div class="details-section">
                        <h5>‚öôÔ∏è Configuration</h5>
                        <div class="details-grid">
                            {% if summary.gerDetails.bridgeAddress %}
                            <div class="detail-item">
                                <span class="detail-label">Bridge Address:</span>
                                <span class="detail-value"><code class="full-address">{{ summary.gerDetails.bridgeAddress }}</code></span>
                            </div>
                            {% endif %}
                            {% if summary.gerDetails.rollupManagerAddress %}
                            <div class="detail-item">
                                <span class="detail-label">Rollup Manager:</span>
                                <span class="detail-value"><code class="full-address">{{ summary.gerDetails.rollupManagerAddress }}</code></span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Exit Roots -->
                    <div class="details-section">
                        <h5>üîó Exit Roots</h5>
                        <div class="details-grid">
                            {% if summary.gerDetails.lastGlobalExitRoot %}
                            <div class="detail-item">
                                <span class="detail-label">Last Global Exit Root:</span>
                                <span class="detail-value"><code class="program-vkey">{{ summary.gerDetails.lastGlobalExitRoot }}</code></span>
                            </div>
                            {% endif %}
                            {% if summary.gerDetails.l1InfoTreeRoot %}
                            <div class="detail-item">
                                <span class="detail-label">L1 Info Tree Root:</span>
                                <span class="detail-value"><code class="program-vkey">{{ summary.gerDetails.l1InfoTreeRoot }}</code></span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Cast Commands Legend -->
                <div class="cast-commands-section">
                    <div class="cast-commands-header" onclick="toggleCastCommands('gerDetails')">
                        üìã Cast Commands <span class="expand-arrow" id="castArrow-gerDetails">‚ñº</span>
                    </div>
                    <div class="cast-commands-content" id="castCommands-gerDetails" style="display: none;">
                        <pre><code># Global Exit Root Manager Details
# Set environment variables
export RPC_URL="{{ summary.rpcURL }}"
export ROLLUP_MANAGER="{{ summary.rollupManagerAddress }}"

# Get Global Exit Root Manager Address
GER_ADDRESS=$(cast call --rpc-url $RPC_URL $ROLLUP_MANAGER "globalExitRootManager()(address)")
export GER_ADDRESS

# GER Version
cast call --rpc-url $RPC_URL $GER_ADDRESS "version()(string)"

# Bridge Address (from GER contract)
cast call --rpc-url $RPC_URL $GER_ADDRESS "bridgeAddress()(address)"

# Rollup Manager Address (from GER contract)
cast call --rpc-url $RPC_URL $GER_ADDRESS "rollupManager()(address)"

# Last Global Exit Root
cast call --rpc-url $RPC_URL $GER_ADDRESS "getLastGlobalExitRoot()(bytes32)"

# L1 Info Tree Root
cast call --rpc-url $RPC_URL $GER_ADDRESS "getRoot()(bytes32)"</code></pre>
                    </div>
                </div>
            </td>
        </tr>
        {% endif %}
        {% if summary.networkAddresses.aggLayerGatewayAddress %}
        <tr class="agglayer-row">
            <th>AggLayer Gateway</th>
            <td>
                <div class="rollup-header" onclick="toggleAggLayerDetails()" style="padding: 8px 0; background: transparent; border: none; justify-content: flex-start; gap: 10px;">
                    <code>{{ summary.networkAddresses.aggLayerGatewayAddress }}</code>
                    <span class="expand-arrow" id="expandArrowAggLayer">‚ñº</span>
                </div>
            </td>
        </tr>
        {% if summary.aggLayerDetails %}
        <tr class="agglayer-details" id="aggLayerDetails" style="display: none;">
            <td colspan="2">
                <div class="details-container">
                    <h4 style="margin: 0 0 15px 0; color: #007bff;">üö™ AggLayer Gateway Details</h4>
                    
                    <!-- System Status -->
                    <div class="details-section">
                        <h5>üö¶ Status & Version</h5>
                        <div class="details-grid">
                            <div class="detail-item">
                                <span class="detail-label">Gateway Version:</span>
                                <span class="detail-value">{{ summary.aggLayerDetails.gatewayVersion if summary.aggLayerDetails.gatewayVersion is not none else "Unknown" }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Multisig Configuration -->
                    <div class="details-section">
                        <h5>üë• Multisig Configuration</h5>
                        <div class="details-grid">
                            <div class="detail-item">
                                <span class="detail-label">Threshold:</span>
                                <span class="detail-value">{{ summary.aggLayerDetails.threshold }}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Signers Count:</span>
                                <span class="detail-value">{{ summary.aggLayerDetails.signersCount }}</span>
                            </div>
                            <div class="detail-item" style="grid-column: 1 / -1;">
                                <span class="detail-label">Signers:</span>
                                <div class="detail-value">
                                    {% if summary.aggLayerDetails.signers and summary.aggLayerDetails.signers|length > 0 %}
                                        {% for signer in summary.aggLayerDetails.signers %}
                                        <div style="display: flex; align-items: center; margin-bottom: 4px; gap: 10px;">
                                            <code class="full-address">{{ signer.address }}</code>
                                            {% if signer.url and signer.url.strip() %}
                                                <small style="color: #666;">
                                                    üîó <a href="{{ signer.url }}" target="_blank" style="color: #1976d2; text-decoration: none;">{{ signer.url }}</a>
                                                </small>
                                            {% endif %}
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <span style="color: #666;">[] (empty array)</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hash Information -->
                    {% if summary.aggLayerDetails.multisigHash %}
                    <div class="details-section">
                        <h5>üîê Hash Information</h5>
                        <div class="details-grid">
                            <div class="detail-item">
                                <span class="detail-label">Multisig Hash:</span>
                                <span class="detail-value"><code class="program-vkey">{{ summary.aggLayerDetails.multisigHash }}</code></span>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Cast Commands Legend -->
                    <div class="cast-commands-section">
                        <div class="cast-commands-header" onclick="toggleCastCommands('aggLayerGateway')">
                            üìã Cast Commands <span class="expand-arrow" id="castArrow-aggLayerGateway">‚ñº</span>
                        </div>
                        <div class="cast-commands-content" id="castCommands-aggLayerGateway" style="display: none;">
                            <pre><code># AggLayer Gateway Details
# Set environment variables
export RPC_URL="{{ summary.rpcURL }}"
export ROLLUP_MANAGER="{{ summary.rollupManagerAddress }}"

# Get AggLayer Gateway Address (returns correct proxy address)
AGGLAYER_GATEWAY=$(cast call --rpc-url $RPC_URL $ROLLUP_MANAGER "aggLayerGateway()(address)")
export AGGLAYER_GATEWAY

# Signers Count
cast call --rpc-url $RPC_URL $AGGLAYER_GATEWAY "getAggchainSignersCount()(uint256)"

# Required Threshold  
cast call --rpc-url $RPC_URL $AGGLAYER_GATEWAY "getThreshold()(uint256)"

# Get All Signers
cast call --rpc-url $RPC_URL $AGGLAYER_GATEWAY "getAggchainSignerInfos()(tuple(address,string)[])"

# Get Multisig Hash
cast call --rpc-url $RPC_URL $AGGLAYER_GATEWAY "getAggchainMultisigHash()(bytes32)"</code></pre>
                        </div>
                    </div>
                </div>
            </td>
        </tr>
        {% endif %}
        {% endif %}
        {% endif %}
    </table>
    {% endif %}
</div>

{% if not summary.error %}
<h2>Active Network Counts</h2>

<div class="stats">
    <div class="stat-card">
        <div class="stat-number">{{ summary.rollupCount or 0 }}</div>
        <div class="stat-label">Total Rollups</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ summary.activeCounts.zkEVM or 0 }}</div>
        <div class="stat-label">Active zkEVM</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ summary.activeCounts.PP or 0 }}</div>
        <div class="stat-label">Active PP</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ summary.activeCounts.ALGateway or 0 }}</div>
        <div class="stat-label">Active ALGateway</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ summary.activeCounts.Validium or 0 }}</div>
        <div class="stat-label">Active Validium</div>
    </div>
</div>


            {% endif %}
        
<style>
/* Cast Commands Styling */
.cast-commands-section {
    margin-top: 15px;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    background-color: #fafafa;
}

.cast-commands-header {
    padding: 10px 15px;
    background-color: #f8f9fa;
    border-bottom: 1px solid #e0e0e0;
    cursor: pointer;
    transition: background-color 0.2s ease;
    font-weight: 600;
    color: #495057;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-radius: 6px 6px 0 0;
}

.cast-commands-header:hover {
    background-color: #e9ecef;
}

.cast-commands-content {
    padding: 0;
}

.cast-commands-content pre {
    margin: 0;
    padding: 15px;
    background-color: #1e1e1e;
    color: #f8f8f2;
    border-radius: 0 0 6px 6px;
    overflow-x: auto;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 12px;
    line-height: 1.4;
}

.cast-commands-content pre code {
    background: none;
    border: none;
    padding: 0;
    color: inherit;
}

/* Rollup Manager Details Styling */
.rollup-manager-row .rollup-header {
    cursor: pointer;
    transition: background-color 0.2s ease;
    border-radius: 4px;
}
.rollup-manager-row .rollup-header:hover {
    background-color: #f8f9fa !important;
}

/* Bridge Details Styling */
.bridge-row .rollup-header {
    cursor: pointer;
    transition: background-color 0.2s ease;
    border-radius: 4px;
}
.bridge-row .rollup-header:hover {
    background-color: #f8f9fa !important;
}

/* Global Exit Root Manager Details Styling */
.ger-row .rollup-header {
    cursor: pointer;
    transition: background-color 0.2s ease;
    border-radius: 4px;
}
.ger-row .rollup-header:hover {
    background-color: #f8f9fa !important;
}

/* AggLayer Gateway Details Styling */
.agglayer-row .rollup-header {
    cursor: pointer;
    transition: background-color 0.2s ease;
    border-radius: 4px;
}
.agglayer-row .rollup-header:hover {
    background-color: #f8f9fa !important;
}
.details-container {
    background-color: #f8f9fa;
    border: 1px solid #e3e6ea;
    border-radius: 6px;
    padding: 20px;
    margin: 10px 0;
    animation: slideDown 0.3s ease-out;
}
@keyframes slideDown {
    from {
        opacity: 0;
        max-height: 0;
        padding: 0 20px;
    }
    to {
        opacity: 1;
        max-height: 1000px;
        padding: 20px;
    }
}
.details-section {
    margin-bottom: 20px;
    border-bottom: 1px solid #e3e6ea;
    padding-bottom: 15px;
}
.details-section:last-child {
    border-bottom: none;
    padding-bottom: 0;
    margin-bottom: 0;
}
.details-section h5 {
    color: #495057;
    margin: 0 0 10px 0;
    font-size: 14px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
.details-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}
.detail-item {
    display: flex;
    flex-direction: column;
    background: white;
    padding: 10px;
    border-radius: 4px;
    border: 1px solid #e9ecef;
}
.detail-label {
    font-size: 12px;
    color: #6c757d;
    font-weight: 600;
    margin-bottom: 4px;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}
.detail-value {
    font-size: 14px;
    color: #212529;
    font-weight: 500;
}
.rollup-manager-details {
    animation: slideDown 0.3s ease-out;
}
.rollup-manager-details[style*="display: none"] {
    animation: slideUp 0.3s ease-out;
}
@keyframes slideUp {
    from {
        opacity: 1;
        max-height: 1000px;
        padding: 20px;
    }
    to {
        opacity: 0;
        max-height: 0;
        padding: 0 20px;
    }
}

/* Rollup list styling */
.rollup-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}
.rollup-item {
    border: 1px solid #dee2e6;
    border-radius: 6px;
    background: white;
    overflow: hidden;
}
.rollup-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    cursor: pointer;
    transition: background-color 0.2s ease;
}
.rollup-header:hover {
    background-color: #e9ecef;
}
.rollup-title {
    display: flex;
    align-items: center;
    gap: 8px;
}
.expand-arrow {
    font-size: 12px;
    transition: transform 0.3s ease;
    color: #6c757d;
}
.expand-arrow.expanded {
    transform: rotate(180deg);
}
.rollup-details {
    padding: 15px;
    background: #fdfdfe;
    animation: slideDown 0.3s ease-out;
}
.rollup-details-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 12px;
}
.error-item {
    grid-column: 1 / -1;
}
.detail-value.error {
    color: #dc3545;
    font-weight: 500;
}
.no-data {
    text-align: center;
    color: #6c757d;
    font-style: italic;
    padding: 20px;
}

/* Full address display */
.full-address {
    word-break: break-all;
    font-size: 12px;
    line-height: 1.3;
    display: block;
}

/* Program VKey styling */
.program-vkey-item {
    grid-column: 1 / -1;
}
.program-vkey {
    word-break: break-all;
    font-size: 11px;
    line-height: 1.4;
    display: block;
    background-color: #f8f9fa;
    padding: 8px;
    border-radius: 4px;
    border: 1px solid #e9ecef;
    max-height: 100px;
    overflow-y: auto;
}
.vkey-simple {
    font-size: 16px;
    font-weight: bold;
    color: #495057;
}
</style>

<script>
function toggleRollupManagerDetails() {
    const details = document.getElementById('rollupManagerDetails');
    const arrow = document.getElementById('expandArrowManager');
    
    if (details.style.display === 'none' || details.style.display === '') {
        details.style.display = 'table-row';
        arrow.classList.add('expanded');
        arrow.innerHTML = '‚ñ≤';
    } else {
        details.style.display = 'none';
        arrow.classList.remove('expanded');
        arrow.innerHTML = '‚ñº';
    }
}

function toggleBridgeDetails() {
    const details = document.getElementById('bridgeDetails');
    const arrow = document.getElementById('expandArrowBridge');
    
    if (details.style.display === 'none' || details.style.display === '') {
        details.style.display = 'table-row';
        arrow.classList.add('expanded');
        arrow.innerHTML = '‚ñ≤';
    } else {
        details.style.display = 'none';
        arrow.classList.remove('expanded');
        arrow.innerHTML = '‚ñº';
    }
}

function toggleGerDetails() {
    const details = document.getElementById('gerDetails');
    const arrow = document.getElementById('expandArrowGer');
    
    if (details.style.display === 'none' || details.style.display === '') {
        details.style.display = 'table-row';
        arrow.classList.add('expanded');
        arrow.innerHTML = '‚ñ≤';
    } else {
        details.style.display = 'none';
        arrow.classList.remove('expanded');
        arrow.innerHTML = '‚ñº';
    }
}

function toggleAggLayerDetails() {
    const details = document.getElementById('aggLayerDetails');
    const arrow = document.getElementById('expandArrowAggLayer');
    
    if (details.style.display === 'none' || details.style.display === '') {
        details.style.display = 'table-row';
        arrow.classList.add('expanded');
        arrow.innerHTML = '‚ñ≤';
    } else {
        details.style.display = 'none';
        arrow.classList.remove('expanded');
        arrow.innerHTML = '‚ñº';
    }
}

function toggleAggLayerUrlDetails() {
    const details = document.getElementById('aggLayerUrlDetails');
    const arrow = document.getElementById('expandArrowAggLayerUrl');
    
    if (details.style.display === 'none' || details.style.display === '') {
        details.style.display = 'table-row';
        arrow.classList.add('expanded');
        arrow.innerHTML = '‚ñ≤';
    } else {
        details.style.display = 'none';
        arrow.classList.remove('expanded');
        arrow.innerHTML = '‚ñº';
    }
}

function toggleCastCommands(sectionId) {
    const details = document.getElementById('castCommands-' + sectionId);
    const arrow = document.getElementById('castArrow-' + sectionId);
    
    if (details.style.display === 'none' || details.style.display === '') {
        details.style.display = 'block';
        arrow.classList.add('expanded');
        arrow.innerHTML = '‚ñ≤';
    } else {
        details.style.display = 'none';
        arrow.classList.remove('expanded');
        arrow.innerHTML = '‚ñº';
    }
}

function toggleRollupDetails(rollupId) {
    const details = document.getElementById('rollupDetails-' + rollupId);
    const arrow = document.getElementById('arrow-' + rollupId);
    
    if (details.style.display === 'none' || details.style.display === '') {
        details.style.display = 'block';
        arrow.classList.add('expanded');
        arrow.innerHTML = '‚ñ≤';
    } else {
        details.style.display = 'none';
        arrow.classList.remove('expanded');
        arrow.innerHTML = '‚ñº';
    }
}

async function toggleOptimisticMode(rollupId, currentState) {
    const button = document.getElementById(`toggleOptimistic-${rollupId}`);
    
    // Disable button during operation
    button.disabled = true;
    button.style.opacity = '0.6';
    button.textContent = 'Processing...';
    
    try {
        const response = await fetch(`/toggle-optimistic-mode/${rollupId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Show success message with transaction hash
            alert(`Successfully ${result.action}d optimistic mode! Transaction hash: ${result.tx_hash}`);
            // Refresh multisig section (avoids full page reload, though optimistic mode field is outside this section)
            await refreshMultisigInfo(rollupId);
            // Note: For full optimistic mode field update visibility, consider refreshing entire rollup section in future
        } else {
            alert(`Failed to ${result.action} optimistic mode: ${result.error || 'Unknown error'}`);
        }
    } catch (error) {
        alert(`Error toggling optimistic mode: ${error.message}`);
    } finally {
        // Re-enable button
        button.disabled = false;
        button.style.opacity = '1';
                button.textContent = currentState ? 'Disable()' : 'Enable()';
    }
}

async function updateThreshold(rollupId) {
    const input = document.getElementById(`newThreshold-${rollupId}`);
    const button = document.getElementById(`updateThreshold-${rollupId}`);
    
    const newThreshold = parseInt(input.value);
    
    if (!newThreshold || newThreshold < 1) {
        alert('Please enter a valid threshold (minimum 1)');
        return;
    }
    
    // Disable button and input during operation
    button.disabled = true;
    input.disabled = true;
    button.style.opacity = '0.6';
    button.textContent = 'Updating...';
    
    try {
        const response = await fetch(`/update-threshold/${rollupId}?new_threshold=${newThreshold}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Show success message with transaction hash
            alert(`Successfully updated threshold from ${result.old_threshold} to ${result.new_threshold}! Transaction hash: ${result.tx_hash}`);
            // Refresh only the multisig section instead of full page reload
            await refreshMultisigInfo(rollupId);
            // Ensure multisig section is expanded to show updated data
            const content = document.getElementById(`multisig-${rollupId}`);
            const arrow = document.getElementById(`multisigArrow-${rollupId}`);
            if (content && content.style.display === 'none') {
                content.style.display = 'block';
                if (arrow) arrow.textContent = '‚ñ≤';
            }
        } else {
            alert(`Failed to update threshold: ${result.detail || 'Unknown error'}`);
        }
    } catch (error) {
        alert(`Error updating threshold: ${error.message}`);
    } finally {
        // Re-enable button and input
        button.disabled = false;
        input.disabled = false;
        button.style.opacity = '1';
        button.textContent = 'Update()';
    }
}

function toggleCertificates(rollupId) {
    const content = document.getElementById(`certificates-${rollupId}`);
    const arrow = document.getElementById(`certArrow-${rollupId}`);
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        arrow.textContent = '‚ñ≤';
        // Auto-load certificates when first opened
        if (content.innerHTML.includes('Loading certificate data...')) {
            refreshCertificates(rollupId);
        }
    } else {
        content.style.display = 'none';
        arrow.textContent = '‚ñº';
    }
}

async function refreshCertificates(rollupId) {
    const content = document.getElementById(`certificates-${rollupId}`);
    const refreshBtn = event ? event.target : null;
    
    // Show loading state
    content.innerHTML = '<div style="font-size: 0.85em; color: #666; margin-bottom: 5px;">üîÑ Refreshing certificate data...</div>';
    
    if (refreshBtn) {
        refreshBtn.disabled = true;
        refreshBtn.style.opacity = '0.6';
    }
    
    try {
        const response = await fetch(`/rollup/${rollupId}/certificates`);
        const data = await response.json();
        
        if (response.ok) {
            content.innerHTML = renderCertificates(data);
        } else {
            content.innerHTML = '<div style="color: #f44336; font-size: 0.85em;">‚ùå Failed to load certificate data</div>';
        }
    } catch (error) {
        content.innerHTML = '<div style="color: #f44336; font-size: 0.85em;">‚ùå Error loading certificates</div>';
    } finally {
        if (refreshBtn) {
            refreshBtn.disabled = false;
            refreshBtn.style.opacity = '1';
        }
    }
}

function getStatusText(statusObj) {
    if (!statusObj || typeof statusObj !== 'object') {
        return 'Unknown';
    }
    
    // Status object structure: { "StatusType": { ... details ... } }
    // Extract the key which represents the status type
    const statusKeys = Object.keys(statusObj);
    if (statusKeys.length === 0) {
        return 'Unknown';
    }
    
    const statusType = statusKeys[0];
    
    // Map internal status names to display names
    switch (statusType) {
        case 'InError':
            return 'Error';
        case 'Settled':
            return 'Settled';
        case 'Pending':
            return 'Pending';
        case 'Generated':
            return 'Generated';
        case 'Candidate':
            return 'Candidate';
        default:
            return statusType; // Return the raw status if unknown
    }
}

function getErrorMessage(statusObj) {
    if (!statusObj || typeof statusObj !== 'object') {
        return null;
    }
    
    // Check if this is an InError status
    if (statusObj.InError && statusObj.InError.error) {
        const errorObj = statusObj.InError.error;
        
        let fullErrorMessage = null;
        
        // Extract the error message from various possible error types
        if (errorObj.InternalError) {
            fullErrorMessage = errorObj.InternalError;
        } else if (errorObj.ValidationError) {
            fullErrorMessage = errorObj.ValidationError;
        } else if (errorObj.NetworkError) {
            fullErrorMessage = errorObj.NetworkError;
        } else {
            // If it's some other error type, try to get the first value
            const errorKeys = Object.keys(errorObj);
            if (errorKeys.length > 0) {
                fullErrorMessage = errorObj[errorKeys[0]];
            }
        }
        
        // Return just the first line for cleaner display
        if (fullErrorMessage) {
            return fullErrorMessage.split('\n')[0].trim();
        }
    }
    
    return null;
}

function getStatusColor(statusObj) {
    const statusText = getStatusText(statusObj);
    
    switch (statusText) {
        case 'Settled':
            return '#4caf50'; // Green
        case 'Pending':
        case 'Generated':
        case 'Candidate':
            return '#ff9800'; // Orange
        case 'Error':
            return '#f44336'; // Red
        default:
            return '#757575'; // Gray
    }
}

function renderCertificates(data) {
    if (!data.certificates) {
        return '<div style="color: #666; font-size: 0.85em;">No AggLayer URL configured</div>';
    }
    
    let html = '<div style="display: grid; gap: 15px;">';
    
    // Latest Known Certificate (blue)
    if (data.certificates.latest_known) {
        const cert = data.certificates.latest_known;
        html += `
            <div style="background: #e3f2fd; padding: 12px; border-radius: 6px; border-left: 4px solid #2196f3;">
                <div style="font-weight: bold; color: #1976d2; margin-bottom: 8px; font-size: 0.9em;">üìã Latest Certificate (Any Status)</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 0.75em;">
                    <!-- Left Column: Regular Data -->
                    <div style="display: grid; gap: 6px;">
                        <div><strong>Height:</strong> ${cert.height || 'N/A'}</div>
                        <div><strong>Epoch:</strong> ${cert.epoch_number || 'N/A'}</div>
                        <div><strong>Status:</strong> <span style="background: ${getStatusColor(cert.status)}; color: white; padding: 1px 4px; border-radius: 2px; font-size: 0.9em;">${getStatusText(cert.status)}</span>${getErrorMessage(cert.status) ? `<br><small style="color: #f44336; margin-top: 4px; display: block; font-style: italic;">${getErrorMessage(cert.status)}</small>` : ''}</div>
                        <div><strong>Cert Index:</strong> ${cert.certificate_index !== null && cert.certificate_index !== undefined ? cert.certificate_index : 'N/A'}</div>
                        ${cert.settlement_block_number ? `<div><strong>Settlement Block:</strong> ${cert.settlement_block_number}</div>` : ''}
                        ${cert.settlement_gas_used ? `<div><strong>Gas Used:</strong> ${cert.settlement_gas_used.toLocaleString()} gas</div>` : ''}
                        ${cert.settlement_datetime ? `<div><strong>Settlement Time:</strong> ${cert.settlement_datetime}${cert.settlement_relative_time ? ` <span style="color: #666;">(${cert.settlement_relative_time})</span>` : ''}</div>` : ''}
        </div>
                    <!-- Right Column: Hashes -->
                    <div style="display: grid; gap: 6px;">
                        <div><strong>Certificate ID:</strong><br><code style="font-size: 0.65em; word-break: break-all; background: rgba(255,255,255,0.7); padding: 2px 4px; border-radius: 2px;">${cert.certificate_id || 'N/A'}</code></div>
                        ${cert.settlement_tx_hash ? `<div><strong>Settlement TX:</strong><br><code style="font-size: 0.65em; word-break: break-all; background: rgba(255,255,255,0.7); padding: 2px 4px; border-radius: 2px;">${cert.settlement_tx_hash}</code></div>` : ''}
                        ${cert.prev_local_exit_root ? `<div><strong>Prev Local Exit Root:</strong><br><code style="font-size: 0.65em; word-break: break-all; background: rgba(255,255,255,0.7); padding: 2px 4px; border-radius: 2px;">${cert.prev_local_exit_root}</code></div>` : ''}
                        ${cert.new_local_exit_root ? `<div><strong>New Local Exit Root:</strong><br><code style="font-size: 0.65em; word-break: break-all; background: rgba(255,255,255,0.7); padding: 2px 4px; border-radius: 2px;">${cert.new_local_exit_root}</code></div>` : ''}
    </div>
</div>
            </div>
        `;
    }
    
    // Latest Settled Certificate (green)
    if (data.certificates.settled) {
        const cert = data.certificates.settled;
        html += `
            <div style="background: #e8f5e8; padding: 12px; border-radius: 6px; border-left: 4px solid #4caf50;">
                <div style="font-weight: bold; color: #2e7d32; margin-bottom: 8px; font-size: 0.9em;">üü¢ Latest Settled Certificate</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 0.75em;">
                    <!-- Left Column: Regular Data -->
                    <div style="display: grid; gap: 6px;">
                        <div><strong>Height:</strong> ${cert.height || 'N/A'}</div>
                        <div><strong>Epoch:</strong> ${cert.epoch_number || 'N/A'}</div>
                        <div><strong>Cert Index:</strong> ${cert.certificate_index !== null && cert.certificate_index !== undefined ? cert.certificate_index : 'N/A'}</div>
                        <div><strong>Settlement Block:</strong> ${cert.settlement_block_number || 'N/A'}</div>
                        <div><strong>Gas Used:</strong> ${cert.settlement_gas_used ? cert.settlement_gas_used.toLocaleString() + ' gas' : 'N/A'}</div>
                        <div><strong>Network ID:</strong> ${cert.network_id || 'N/A'}</div>
                        <div><strong>Settlement Time:</strong> ${cert.settlement_datetime || 'N/A'}${cert.settlement_relative_time ? ` <span style="color: #666;">(${cert.settlement_relative_time})</span>` : ''}</div>
</div>
                    <!-- Right Column: Hashes -->
                    <div style="display: grid; gap: 6px;">
                        <div><strong>Certificate ID:</strong><br><code style="font-size: 0.65em; word-break: break-all; background: rgba(255,255,255,0.7); padding: 2px 4px; border-radius: 2px;">${cert.certificate_id || 'N/A'}</code></div>
                        <div><strong>Settlement TX:</strong><br><code style="font-size: 0.65em; word-break: break-all; background: rgba(255,255,255,0.7); padding: 2px 4px; border-radius: 2px;">${cert.settlement_tx_hash || 'N/A'}</code></div>
                        <div><strong>Prev Local Exit Root:</strong><br><code style="font-size: 0.65em; word-break: break-all; background: rgba(255,255,255,0.7); padding: 2px 4px; border-radius: 2px;">${cert.prev_local_exit_root || 'N/A'}</code></div>
                        <div><strong>New Local Exit Root:</strong><br><code style="font-size: 0.65em; word-break: break-all; background: rgba(255,255,255,0.7); padding: 2px 4px; border-radius: 2px;">${cert.new_local_exit_root || 'N/A'}</code></div>
                        ${cert.settlement_block_hash ? `<div><strong>Settlement Block Hash:</strong><br><code style="font-size: 0.65em; word-break: break-all; background: rgba(255,255,255,0.7); padding: 2px 4px; border-radius: 2px;">${cert.settlement_block_hash}</code></div>` : ''}
                        ${cert.settlement_l1_info_root ? `<div><strong>L1 Info Root:</strong><br><code style="font-size: 0.65em; word-break: break-all; background: rgba(255,255,255,0.7); padding: 2px 4px; border-radius: 2px;">${cert.settlement_l1_info_root}</code></div>` : ''}
                    </div>
                </div>
            </div>
        `;
    }
    
    // Previous Settlement Event (gray)
    if (data.recentSettlements && data.recentSettlements.length > 0) {
        const settlement = data.recentSettlements[0];
        html += `
            <div style="background: #f5f5f5; padding: 12px; border-radius: 6px; border-left: 4px solid #757575;">
                <div style="font-weight: bold; color: #424242; margin-bottom: 8px; font-size: 0.9em;">üìú Previous Settlement Event</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 0.75em;">
                    <!-- Left Column: Regular Data -->
                    <div style="display: grid; gap: 6px;">
                        <div><strong>Settlement Block:</strong> ${settlement.block_number || 'N/A'}</div>
                        <div><strong>Rollup ID:</strong> ${settlement.rollup_id || 'N/A'}</div>
                        <div><strong>Gas Used:</strong> ${settlement.settlement_gas_used ? settlement.settlement_gas_used.toLocaleString() + ' gas' : 'N/A'}</div>
                        <div><strong>Timestamp:</strong> ${settlement.timestamp || 'N/A'}</div>
                        <div><strong>Settlement Time:</strong> ${settlement.datetime || 'N/A'}${settlement.relative_time ? ` <span style="color: #666;">(${settlement.relative_time})</span>` : ''}</div>
                    </div>
                    <!-- Right Column: Hashes -->
                    <div style="display: grid; gap: 6px;">
                        <div><strong>Trusted Aggregator:</strong><br><code style="font-size: 0.65em; word-break: break-all; background: rgba(255,255,255,0.7); padding: 2px 4px; border-radius: 2px;">${settlement.trusted_aggregator || 'N/A'}</code></div>
                        <div><strong>Transaction Hash:</strong><br><code style="font-size: 0.65em; word-break: break-all; background: rgba(255,255,255,0.7); padding: 2px 4px; border-radius: 2px;">${settlement.transaction_hash || 'N/A'}</code></div>
                        <div><strong>Prev Local Exit Root:</strong><br><code style="font-size: 0.65em; word-break: break-all; background: rgba(255,255,255,0.7); padding: 2px 4px; border-radius: 2px;">${settlement.prev_local_exit_root || 'N/A'}</code></div>
                        <div><strong>New Local Exit Root:</strong><br><code style="font-size: 0.65em; word-break: break-all; background: rgba(255,255,255,0.7); padding: 2px 4px; border-radius: 2px;">${settlement.new_local_exit_root || 'N/A'}</code></div>
                        <div><strong>Prev Pessimistic Root:</strong><br><code style="font-size: 0.65em; word-break: break-all; background: rgba(255,255,255,0.7); padding: 2px 4px; border-radius: 2px;">${settlement.prev_pessimistic_root || 'N/A'}</code></div>
                        <div><strong>New Pessimistic Root:</strong><br><code style="font-size: 0.65em; word-break: break-all; background: rgba(255,255,255,0.7); padding: 2px 4px; border-radius: 2px;">${settlement.new_pessimistic_root || 'N/A'}</code></div>
                        ${settlement.l1_info_root ? `<div><strong>L1 Info Root:</strong><br><code style="font-size: 0.65em; word-break: break-all; background: rgba(255,255,255,0.7); padding: 2px 4px; border-radius: 2px;">${settlement.l1_info_root}</code></div>` : ''}
                        ${settlement.settlement_block_hash ? `<div><strong>Settlement Block Hash:</strong><br><code style="font-size: 0.65em; word-break: break-all; background: rgba(255,255,255,0.7); padding: 2px 4px; border-radius: 2px;">${settlement.settlement_block_hash}</code></div>` : ''}
                    </div>
                </div>
            </div>
        `;
    }
    
    html += '</div>';
    
    if (!data.certificates.latest_known && !data.certificates.settled && (!data.recentSettlements || data.recentSettlements.length === 0)) {
        return '<div style="color: #666; font-size: 0.85em;">No certificate data available</div>';
    }
    
    return html;
}

function toggleMultisigInfo(rollupId) {
    const content = document.getElementById(`multisig-${rollupId}`);
    const arrow = document.getElementById(`multisigArrow-${rollupId}`);
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        arrow.textContent = '‚ñ≤';
        // Auto-load multisig info when first opened
        if (content.innerHTML.includes('Loading multisig data...')) {
            refreshMultisigInfo(rollupId);
        }
    } else {
        content.style.display = 'none';
        arrow.textContent = '‚ñº';
    }
}

async function refreshMultisigInfo(rollupId) {
    const content = document.getElementById(`multisig-${rollupId}`);
    const refreshBtn = event ? event.target : null;
    
    // Show loading state
    const originalContent = content.innerHTML;
    content.innerHTML = '<div style="padding: 10px; font-size: 0.85em; color: #666;">üîÑ Refreshing multisig data...</div>';
    
    if (refreshBtn) {
        refreshBtn.disabled = true;
        refreshBtn.style.opacity = '0.6';
    }
    
    try {
        const response = await fetch(`/rollup/${rollupId}/multisig`);
        const data = await response.json();
        
        if (response.ok) {
            content.innerHTML = renderMultisigInfo(data);
        } else {
            content.innerHTML = '<div style="color: #f44336; font-size: 0.85em;">‚ùå Failed to load multisig data</div>';
        }
    } catch (error) {
        content.innerHTML = '<div style="color: #f44336; font-size: 0.85em;">‚ùå Error loading multisig data</div>';
    } finally {
        if (refreshBtn) {
            refreshBtn.disabled = false;
            refreshBtn.style.opacity = '1';
        }
    }
}

function renderMultisigInfo(data) {
    if (!data.rollupSignersCount && data.rollupSignersCount !== 0) {
        return '<div style="color: #666; font-size: 0.85em;">No multisig data available</div>';
    }
    
    let html = '<div class="details-grid">';
    
    // Signer Count
    html += `
        <div class="detail-item">
            <span class="detail-label">Signer Count:</span>
            <span class="detail-value">${data.rollupSignersCount || 0}</span>
        </div>
    `;
    
    // Threshold
    html += `
        <div class="detail-item">
            <span class="detail-label">Threshold:</span>
            <span class="detail-value">
                <span style="background: #f0f8ff; padding: 2px 6px; border-radius: 3px; font-weight: bold; border: 1px solid #e1e8ed;">${data.rollupThreshold || 0}</span>
    `;
    
    // Add threshold update controls if applicable
    if (!data.useDefaultSigners && data.hasAgchainManagerKey) {
        html += `
                <span style="margin: 0 8px; color: #666; font-size: 0.9em;">‚Üí</span>
                <input 
                    type="number" 
                    id="newThreshold-${data.rollupID}" 
                    min="1" 
                    max="${data.rollupSignersCount || 10}"
                    value="${data.rollupThreshold || 0}"
                    style="width: 50px; padding: 3px 6px; font-size: 0.85em; border: 2px solid #2196f3; border-radius: 4px; background: #fff8e1; font-weight: 500;">
                <button 
                    id="updateThreshold-${data.rollupID}"
                    onclick="updateThreshold(${data.rollupID})"
                    style="margin-left: 6px; padding: 4px 8px; font-size: 0.8em; border: 1px solid #1976d2; border-radius: 4px; cursor: pointer; background: #2196f3; color: white; font-weight: 500;">
                    Update()
                </button>
        `;
    }
    
    html += `
            </span>
        </div>
    `;
    
    // Use AgglGW signers
    html += `
        <div class="detail-item">
            <span class="detail-label">Use AgglGW signers:</span>
            <span class="detail-value">${data.useDefaultSigners || false}</span>
        </div>
    `;
    
    // Multisig hash
    if (data.rollupMultisigHash && data.rollupMultisigHash !== "0x") {
        html += `
            <div class="detail-item">
                <span class="detail-label">Multisig hash:</span>
                <span class="detail-value"><code class="program-vkey">${data.rollupMultisigHash}</code></span>
            </div>
        `;
    }
    
    // Signers
    if (data.rollupSigners && data.rollupSigners.length > 0) {
        html += `
            <div class="detail-item" style="grid-column: 1 / -1;">
                <span class="detail-label">Signers:</span>
                <div class="detail-value">
        `;
        
        data.rollupSigners.forEach(signer => {
            html += `
                <div style="display: flex; align-items: center; margin-bottom: 4px; gap: 10px;">
                    <code class="full-address">${signer.address}</code>
            `;
            
            if (signer.url && signer.url.trim()) {
                html += `
                    <small style="color: #666;">
                        üîó <a href="${signer.url}" target="_blank" style="color: #1976d2; text-decoration: none;">${signer.url}</a>
                    </small>
                `;
            }
            
            html += '</div>';
        });
        
        html += `
                </div>
            </div>
        `;
    }
    
    html += '</div>';
    return html;
}
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}Rollup {{ rollup.rollupID }} - Kurtosis{% endblock %}

{% block header %}Rollup {{ rollup.rollupID }} Details{% endblock %}

{% block nav %}
{% endblock %}

{% block content %}
<div class="card">
    <h2>
        {{ rollup.networkName or ('Rollup ' + rollup.rollupID|string) }}
        <span class="badge badge-{{ rollup.type or 'Unknown' }}">{{ rollup.type or 'Unknown' }}</span>
    </h2>
</div>

<h2>Basic Information</h2>

<table class="detail-table">
    <tr>
        <th>Rollup ID</th>
        <td>{{ rollup.rollupID }}</td>
    </tr>
    <tr>
        <th>Network Name</th>
        <td>{{ rollup.networkName or 'Unknown' }}</td>
    </tr>
    <tr>
        <th>Chain ID</th>
        <td>{{ rollup.chainID }}</td>
    </tr>
    <tr>
        <th>Type</th>
        <td><span class="badge badge-{{ rollup.type or 'Unknown' }}">{{ rollup.type or 'Unknown' }}</span></td>
    </tr>
    <tr>
        <th>Verifier Type</th>
        <td>
            {{ rollup.rollupVerifierTypeFriendly or rollup.rollupVerifierType }}
            <span style="color: #666; font-size: 0.9em;">({{ rollup.rollupVerifierType }})</span>
        </td>
    </tr>
    <tr>
        <th>Rollup Type ID</th>
        <td>{{ rollup.rollupTypeID }}</td>
    </tr>
    <tr>
        <th>Fork ID</th>
        <td><code>{{ rollup.forkID }}</code></td>
    </tr>
    <tr>
        <th>Last Verified Batch</th>
        <td>{{ rollup.lastVerifiedBatch }}</td>
    </tr>
    {% if rollup.programVKey %}
    <tr>
        <th>Program VKey</th>
        <td><code>{{ rollup.programVKey }}</code></td>
    </tr>
    {% endif %}
</table>

<h2>Contract Information</h2>

<table class="detail-table">
    <tr>
        <th>Rollup Contract</th>
        <td>
            {% if rollup.rollupContract != "0x0000000000000000000000000000000000000000" %}
            <code>{{ rollup.rollupContract }}</code>
            {% else %}
            <span class="status-error">Not Deployed</span>
            {% endif %}
        </td>
    </tr>
    {% if rollup.trustedSequencerURL %}
    <tr>
        <th>Trusted Sequencer URL</th>
        <td><code>{{ rollup.trustedSequencerURL }}</code></td>
    </tr>
    {% endif %}
    {% if rollup.trustedSequencer %}
    <tr>
        <th>Trusted Sequencer Address</th>
        <td><code>{{ rollup.trustedSequencer }}</code></td>
    </tr>
    {% endif %}
</table>

<h2>Rollup-Specific Contract Addresses</h2>

<table class="detail-table">
    {% if rollup.consensusImplementation %}
    <tr>
        <th>Consensus Implementation</th>
        <td>
            {% if rollup.consensusImplementation != "0x0000000000000000000000000000000000000000" %}
                <code>{{ rollup.consensusImplementation }}</code>
            {% else %}
                <code style="color: #666;">{{ rollup.consensusImplementation }}</code> <span style="color: #666; font-size: 0.9em;">(zero address)</span>
            {% endif %}
        </td>
    </tr>
    {% endif %}
    {% if rollup.verifier %}
    <tr>
        <th>Verifier Contract</th>
        <td>
            {% if rollup.verifier != "0x0000000000000000000000000000000000000000" %}
                <code>{{ rollup.verifier }}</code>
            {% else %}
                <code style="color: #666;">{{ rollup.verifier }}</code> 
                <span style="color: #666; font-size: 0.9em;">
                    (zero address - 
                    {% if rollup.rollupVerifierType == 1 %}
                        expected for Pessimistic Proof rollups
                    {% elif rollup.rollupVerifierType == 2 %}
                        expected for AggLayer Gateway rollups  
                    {% else %}
                        may indicate missing verifier
                    {% endif %}
                    )
                </span>
            {% endif %}
        </td>
    </tr>
    {% endif %}
    {% if rollup.genesis %}
    <tr>
        <th>Genesis Block Hash</th>
        <td><code style="word-break: break-all;">{{ rollup.genesis }}</code></td>
    </tr>
    {% endif %}
    {% if rollup.rollupTypeConsensus and rollup.rollupTypeConsensus != rollup.consensusImplementation and rollup.rollupTypeConsensus != "0x0000000000000000000000000000000000000000" %}
    <tr>
        <th>Rollup Type Consensus</th>
        <td><code>{{ rollup.rollupTypeConsensus }}</code></td>
    </tr>
    {% endif %}
    {% if rollup.rollupTypeVerifier and rollup.rollupTypeVerifier != rollup.verifier and rollup.rollupTypeVerifier != "0x0000000000000000000000000000000000000000" %}
    <tr>
        <th>Rollup Type Verifier</th>
        <td><code>{{ rollup.rollupTypeVerifier }}</code></td>
    </tr>
    {% endif %}
</table>

{% if rollup.certificates %}
<h2>AggLayer Certificates</h2>

{% if rollup.certificates.epoch_config %}
<div class="card" style="margin-bottom: 20px; background-color: #f8f9fa;">
    <h3>‚è∞ AggLayer Epoch Configuration</h3>
    <table class="detail-table">
        <tr>
            <th>Genesis Block</th>
            <td>{{ rollup.certificates.epoch_config.genesis_block }}</td>
        </tr>
        <tr>
            <th>Epoch Duration</th>
            <td>{{ rollup.certificates.epoch_config.epoch_duration }} seconds</td>
        </tr>
    </table>
</div>
{% endif %}

{% if rollup.certificates.latest_known and rollup.certificates.latest_known != rollup.certificates.settled %}
<div class="card" style="margin-bottom: 20px; background-color: #e3f2fd;">
    <h3>üìã Latest Certificate (Any Status)</h3>
    <p style="color: #666; margin-bottom: 15px;">This shows the most recent certificate regardless of status - may be more recent than settled certificates.</p>
    <table class="detail-table">
        <tr>
            <th>Height</th>
            <td>{{ rollup.certificates.latest_known.height or 'N/A' }}</td>
        </tr>
        <tr>
            <th>Status</th>
            <td><span class="badge" style="background-color: {% if rollup.certificates.latest_known.status == 'Settled' %}green{% elif rollup.certificates.latest_known.status == 'Pending' %}orange{% else %}gray{% endif %}; color: white;">{{ rollup.certificates.latest_known.status or 'Unknown' }}</span></td>
        </tr>
        <tr>
            <th>Epoch Number</th>
            <td>{{ rollup.certificates.latest_known.epoch_number or 'N/A' }}</td>
        </tr>
        <tr>
            <th>Certificate ID</th>
            <td><code style="word-break: break-all;">{{ rollup.certificates.latest_known.certificate_id or 'N/A' }}</code></td>
        </tr>
        {% if rollup.certificates.latest_known.settlement_datetime %}
        <tr>
            <th>Settlement Time</th>
            <td><strong>{{ rollup.certificates.latest_known.settlement_datetime }}</strong></td>
        </tr>
        {% endif %}
        {% if rollup.certificates.latest_known.settlement_tx_hash %}
        <tr>
            <th>Settlement TX Hash</th>
            <td><code style="word-break: break-all;">{{ rollup.certificates.latest_known.settlement_tx_hash }}</code></td>
        </tr>
        {% endif %}
    </table>
</div>
{% endif %}

{% if rollup.certificates.settled %}
<div class="card" style="margin-bottom: 20px;">
    <h3>üü¢ Latest Settled Certificate</h3>
    <table class="detail-table">
        <tr>
            <th>Height</th>
            <td>{{ rollup.certificates.settled.height or 'N/A' }}</td>
        </tr>
        <tr>
            <th>Epoch Number</th>
            <td>{{ rollup.certificates.settled.epoch_number or 'N/A' }}</td>
        </tr>
        <tr>
            <th>Certificate Index</th>
            <td>{% if rollup.certificates.settled.certificate_index is not none %}{{ rollup.certificates.settled.certificate_index }}{% else %}N/A{% endif %}</td>
        </tr>
        <tr>
            <th>Certificate ID</th>
            <td><code style="word-break: break-all;">{{ rollup.certificates.settled.certificate_id or 'N/A' }}</code></td>
        </tr>
        {% if rollup.certificates.settled.settlement_datetime %}
        <tr>
            <th>Settlement Time</th>
            <td><strong>{{ rollup.certificates.settled.settlement_datetime }}</strong>{% if rollup.certificates.settled.settlement_relative_time %} <span style="color: #666;">({{ rollup.certificates.settled.settlement_relative_time }})</span>{% endif %}</td>
        </tr>
        {% endif %}
        {% if rollup.certificates.settled.settlement_block_number %}
        <tr>
            <th>Settlement Block</th>
            <td>{{ rollup.certificates.settled.settlement_block_number }}</td>
        </tr>
        {% endif %}
        {% if rollup.certificates.settled.settlement_gas_used %}
        <tr>
            <th>Settlement Gas Used</th>
            <td>{{ '{:,}'.format(rollup.certificates.settled.settlement_gas_used) }} gas</td>
        </tr>
        {% endif %}
        <tr>
            <th>Settlement TX Hash</th>
            <td><code style="word-break: break-all;">{{ rollup.certificates.settled.settlement_tx_hash or 'N/A' }}</code></td>
        </tr>
        <tr>
            <th>Prev Local Exit Root</th>
            <td><code style="word-break: break-all;">{{ rollup.certificates.settled.prev_local_exit_root or 'N/A' }}</code></td>
        </tr>
        <tr>
            <th>New Local Exit Root</th>
            <td><code style="word-break: break-all;">{{ rollup.certificates.settled.new_local_exit_root or 'N/A' }}</code></td>
        </tr>
        {% if rollup.certificates.settled.settlement_block_hash %}
        <tr>
            <th>Settlement Block Hash</th>
            <td><code style="word-break: break-all;">{{ rollup.certificates.settled.settlement_block_hash }}</code></td>
        </tr>
        {% endif %}
        {% if rollup.certificates.settled.settlement_l1_info_root %}
        <tr>
            <th>L1 Info Root</th>
            <td><code style="word-break: break-all;">{{ rollup.certificates.settled.settlement_l1_info_root }}</code></td>
        </tr>
        {% endif %}
    </table>
</div>
{% else %}
<div class="card" style="margin-bottom: 20px; background-color: #f5f5f5;">
    <h3>üìã No Settled Certificates</h3>
    <p>No settled certificates found for this rollup.</p>
</div>
{% endif %}

{% if rollup.recentSettlements %}
<div class="card" style="margin-bottom: 20px;">
    <h3>üìú Previous Settled Certificate</h3>
    <p style="color: #666; margin-bottom: 15px;">The most recent certificate settlement before the current one.</p>
    
    {% if rollup.recentSettlements|length > 0 %}
    {% set settlement = rollup.recentSettlements[0] %}
    <table class="detail-table">
        <tr>
            <th>Height</th>
            <td>{{ settlement.height or 'N/A' }}</td>
        </tr>
        <tr>
            <th>Epoch Number</th>
            <td>{{ settlement.epoch_number or 'N/A' }}</td>
        </tr>
        <tr>
            <th>Certificate Index</th>
            <td>{% if settlement.certificate_index is not none %}{{ settlement.certificate_index }}{% else %}{{ settlement.certificate_index or 'N/A' }}{% endif %}</td>
        </tr>
        <tr>
            <th>Certificate ID</th>
            <td>{% if settlement.certificate_id and settlement.certificate_id != 'N/A' %}<code style="word-break: break-all;">{{ settlement.certificate_id }}</code>{% else %}{{ settlement.certificate_id or 'N/A' }}{% endif %}</td>
        </tr>
        <tr>
            <th>Settlement Time</th>
            <td><strong>{{ settlement.datetime }}</strong>{% if settlement.relative_time %} <span style="color: #666;">({{ settlement.relative_time }})</span>{% endif %}</td>
        </tr>
        <tr>
            <th>Settlement Block</th>
            <td>{{ settlement.block_number }}</td>
        </tr>
        <tr>
            <th>Settlement Gas Used</th>
            <td>{% if settlement.settlement_gas_used %}{{ '{:,}'.format(settlement.settlement_gas_used) }} gas{% else %}N/A{% endif %}</td>
        </tr>
        <tr>
            <th>Settlement TX Hash</th>
            <td><code style="word-break: break-all;">{{ settlement.transaction_hash }}</code></td>
        </tr>
        <tr>
            <th>Prev Local Exit Root</th>
            <td><code style="word-break: break-all;">{{ settlement.prev_local_exit_root }}</code></td>
        </tr>
        <tr>
            <th>New Local Exit Root</th>
            <td><code style="word-break: break-all;">{{ settlement.new_local_exit_root }}</code></td>
        </tr>
        <tr>
            <th>Settlement Block Hash</th>
            <td>{% if settlement.settlement_block_hash %}<code style="word-break: break-all;">{{ settlement.settlement_block_hash }}</code>{% else %}N/A{% endif %}</td>
        </tr>
        <tr>
            <th>L1 Info Root</th>
            <td><code style="word-break: break-all;">{{ settlement.l1_info_root }}</code></td>
        </tr>
    </table>
    {% else %}
    <p style="background-color: #f5f5f5; padding: 15px; border-radius: 5px;">No previous certificate settlements found (this may be the first settlement).</p>
    {% endif %}
</div>
{% endif %}

{% endif %}


<div style="margin-top: 30px;">
    <a href="/" style="color: #007bff; text-decoration: none; font-weight: bold;">
        ‚Üê Back to Dashboard
    </a>
</div>
{% endblock %}
